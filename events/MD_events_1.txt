#############################
#####  魔法使いイベント  ######
#############################
namespace = magical_discoveries
# magical_discoveries.97-102		通信の確立
# magical_discoveries.105–107	Main menus
# magical_discoveries.121-122	Opinion gain from active Strategic Resource deals
# magical_discoveries.123-128	Hire a Governor
# magical_discoveries.130-135	Strategic Resource deals
# magical_discoveries.140-144	wizard Enclave destroyed
# magical_discoveries.150-152	Strategic Resource deal elapses
# magical_discoveries.155–163	Attacking a wizard Enclave
# magical_discoveries.170-171	Defaulting on Strategic Resource deal
# NOTE: any changes to these event IDs should be reflected in the has_wizard_event = {} scripted effect.
# 飛び地（マーセナリーを含む）は3～4年後にコンタクトを取る
fleet_event = {
	id = magical_discoveries.97
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		if = {
			limit = {
				solar_system = {
					has_star_flag = wizard_a_enclave_star_flag
				}
			}
			exists = event_target:wizard_a_country
			owner = {
				NOT = {
					has_communications = event_target:wizard_a_country
				}
			}
		}
		else_if = {
			limit = {
				solar_system = {
					has_star_flag = wizard_b_enclave_star_flag
				}
			}
			exists = event_target:wizard_b_country
			owner = {
				NOT = {
					has_communications = event_target:wizard_b_country
				}
			}
		}
		else_if = {
			limit = {
				solar_system = {
					has_star_flag = wizard_c_enclave_star_flag
				}
			}
			exists = event_target:wizard_c_country
			owner = {
				NOT = {
					has_communications = event_target:wizard_c_country
				}
			}
		}
	}
	immediate = {
		owner = {
			establish_communications_no_message = this
			country_event = {
				id = magical_discoveries.98
			}
		}
	}
}

# エンクレイブ、通信を確立
country_event = {
	id = magical_discoveries.98
	title = magical_discoveries.98.name
	desc = magical_discoveries.98.desc
	picture = GFX_evt_space_station
	show_sound = event_radio_chatter
	is_triggered_only = yes
	after = {
		hidden_effect = {
			from = {
				switch = {
					trigger = has_country_flag
					wizard_enclave_country = {
						country_event = {
							id = magical_discoveries.101
						}
					}
					default = {
						log_error = "Unexpected enclave type or missing script flag"
					}
				}
			}
		}
	}
	option = {
		name = SCUM
		trigger = {
			has_valid_civic = civic_fanatic_purifiers
		}
	}
	option = {
		name = TASTY
		trigger = {
			has_valid_civic = civic_hive_devouring_swarm
		}
	}
	option = {
		name = EXTERMINATE
		trigger = {
			has_valid_civic = civic_machine_terminator
		}
	}
	option = {
		name = leviathans.98.a
		trigger = {
			NOR = {
				has_valid_civic = civic_fanatic_purifiers
				has_valid_civic = civic_hive_devouring_swarm
				has_valid_civic = civic_machine_terminator
			}
		}
	}
}

# Enclave Communication Spread
# via on_decade_pulse_country
country_event = {
	id = magical_discoveries.560
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		is_country_type = university_of_magic
		any_relation = {
			is_country_type = default
			any_relation = {
				is_country_type = default
				NOT = {
					has_communications = ROOT
				}
			}
		}
	}
	immediate = {
		random_relation = {
			limit = {
				any_relation = {
					is_country_type = default
					NOT = {
						has_communications = ROOT
					}
				}
			}
			random_relation = {
				limit = {
					is_country_type = default
					NOT = {
						has_communications = ROOT
					}
				}
				root = {
					establish_communications_no_message = prev
				}
				country_event = {
					id = magical_discoveries.98
				}
			}
		}
	}
}

# メテーリンク魔法魔術学院 通信の確立
# wizards gatekeeper event
# Via on_custom_diplomacy｜this = 対象国（プレーヤー）、from = 接触している国。
country_event = {
	id = magical_discoveries.100
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from = {
			is_country_type = university_of_magic
		}
		has_wizard_event = no
		OR = {
			AND = {
				# NOT = { has_country_flag = attacked_xuracorp }
				from = {
					has_country_flag = wizard_enclave_country_1
				}
			}
			AND = {
				# NOT = { has_country_flag = attacked_riggans }
				from = {
					has_country_flag = wizard_enclave_country_2
				}
			}
			AND = {
				# NOT = { has_country_flag = attacked_muutagans }
				from = {
					has_country_flag = wizard_enclave_country_3
				}
			}
		}
	}
	immediate = {
		from = {
			switch = {
				trigger = has_country_flag
				wizard_enclave_country_1 = {
					root = {
						country_event = {
							id = magical_discoveries.105
						}
					}
				}
				wizard_enclave_country_2 = {
					root = {
						country_event = {
							id = magical_discoveries.106
						}
					}
				}
				wizard_enclave_country_3 = {
					root = {
						country_event = {
							id = magical_discoveries.107
						}
					}
				}
			}
		}
	}
}

# コミュニケーション確立（スコープの確立）
# via finish_first_contact_effect / action.11 / magical_discoveries.98
# this = enclave country
country_event = {
	id = magical_discoveries.101
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		random_controlled_ship = {
			solar_system = {
				save_event_target_as = wizard_system
			}
		}
		from = {
			country_event = {
				id = magical_discoveries.102
			}
		}
	}
}

# wizard Introduction (all wizards)
# this = player country | from = wizard Enclave country | event_target:wizard_system = Twizard Enclave system
country_event = {
	id = magical_discoveries.102
	title = magical_discoveries.102.name
	desc = {
		text = magical_discoveries.102a.desc
		trigger = {
			FROM = {
				has_country_flag = wizard_enclave_country_1
			}
		}
	}
	desc = {
		text = magical_discoveries.102b.desc
		trigger = {
			FROM = {
				has_country_flag = wizard_enclave_country_2
			}
		}
	}
	desc = {
		text = magical_discoveries.102c.desc
		trigger = {
			FROM = {
				has_country_flag = wizard_enclave_country_3
			}
		}
	}
	is_triggered_only = yes
	diplomatic = yes
	custom_gui = "enclave_wizard_window"
	custom_gui_option = "enclave_wizard_option"
	picture_event_data = {
		portrait = from
		room = enclave_wizard_room
	}
	option = {
		name = {
			trigger = {
				has_valid_civic = civic_fanatic_purifiers
			}
			text = SCUM
		}
		name = {
			trigger = {
				has_valid_civic = civic_hive_devouring_swarm
			}
			text = TASTY
		}
		name = {
			trigger = {
				has_valid_civic = civic_machine_terminator
			}
			text = EXTERMINATE
		}
		name = {
			trigger = {
				NOR = {
					has_valid_civic = civic_fanatic_purifiers
					has_valid_civic = civic_hive_devouring_swarm
					has_valid_civic = civic_machine_terminator
				}
			}
			text = leviathans.502.a
		}
		default_hide_option = yes
	}
}

# メテーリンク魔法魔術学院 Main Menu
# fromfrom / event_target:wizard_a_country = メテーリンク魔法魔術学院
country_event = {
	id = magical_discoveries.105
	title = magical_discoveries.100.name
	desc = magical_discoveries.100a.desc
	desc = magical_discoveries.100b.desc
	desc = magical_discoveries.100c.desc
	desc = magical_discoveries.100d.desc
	desc = magical_discoveries.100e.desc
	desc = magical_discoveries.100f.desc
	is_triggered_only = yes
	diplomatic = yes
	custom_gui = "enclave_wizard_window"
	custom_gui_option = "enclave_wizard_option"
	picture_event_data = {
		portrait = event_target:wizard_a_country
		room = enclave_wizard_room
	}
	location = event_target:wizard_a_enclave_system
	trigger = {
		#このイベントを継承するイベント用
		NOR = {
			has_global_flag = wizard_a_destroyed
			has_country_flag = attacked_wizard_a
		}
	}
	option = {
		name = {
			trigger = {
				has_valid_civic = civic_fanatic_purifiers
			}
			text = SCUM
		}
		name = {
			trigger = {
				has_valid_civic = civic_hive_devouring_swarm
			}
			text = TASTY
		}
		name = {
			trigger = {
				has_valid_civic = civic_machine_terminator
			}
			text = EXTERMINATE
		}
		trigger = {
			is_homicidal = yes
		}
	}
	# 技術交渉
	option = {
		name = magical_discoveries.105.c
		custom_tooltip = wizard_tt_strategicresource
		trigger = {
			is_homicidal = no
		}
		allow = {
			custom_tooltip = {
				fail_text = magical_discoveries.105.c.sr2
			}
		}
		hidden_effect = {
			country_event = {
				id = magical_discoveries.130
			}
		}
	}
	# 生徒を送り出し
	option = {
		name = magical_discoveries.105.z
		custom_tooltip = wizard_tt_governor
		trigger = {
			is_homicidal = no
		}
		allow = {
			custom_tooltip = {
				text = magical_discoveries.105.c.trust
				event_target:xuracorp_country = {
					trust = {
						who = root
						value >= 50
					}
				}
			}
			custom_tooltip = {
				fail_text = already_hired_wizard_governor
				NOT = {
					has_country_flag = hired_wizard_governor_xur
				}
			}
		}
		hidden_effect = {
			country_event = {
				id = magical_discoveries.123
			}
		}
	}
	# 遺物販売
	option = {
		name = magical_discoveries.105.e
		trigger = {
			has_active_xuracorp_trade = yes
		}
		custom_tooltip = end_trade_1
		custom_tooltip = opinion-5
		hidden_effect = {
			remove_xuracorp_trades = yes
			event_target:wizard_a_enclave_system = {
				add_trust = {
					who = root
					amount = -5
				}
			}
		}
		is_dialog_only = yes
		response_text = magical_discoveries.105.e.response
	}
	option = {
		name = leviathans.105.d
		default_hide_option = yes
		trigger = {
			is_homicidal = no
		}
	}
}
