###############################
#####  クライシスイベント  ######
###############################
namespace = magical_discoveries_crisis
## 	天使を目撃
event = {
	## イベントの基本情報
	id = magical_discoveries_crisis.0
	hide_window = yes
	## イベントの発生条件
	# is_triggered_only = yes
	# fire_only_once = yes
	trigger = {
		has_global_flag = LearnNecromancyFlag
		NOT = {
			has_global_flag = AppearanceAngelFlag
		}
	}
	## イベントの効果
	immediate = {
		every_country = {
			country_event = {
				id = magical_discoveries_crisis.1
			}
			country_event = {
				id = magical_discoveries_crisis.2
				days = 360
			}
		}
	}
}

## 	天使を目撃
country_event = {
	## イベントの基本情報
	id = magical_discoveries_crisis.1
	title = magical_discoveries_crisis.1.name
	desc = magical_discoveries_crisis.1.desc
	picture = GFX_evt_ship_in_orbit
	hide_window = no
	## イベントの発生条件
	is_triggered_only = yes
	# fire_only_once = yes
	## イベントの効果
	option = {
		name = magical_discoveries_crisis.1a.name
		set_global_flag = AppearanceAngelFlag
	}
}

## 	天使を発見
country_event = {
	## イベントの基本情報
	id = magical_discoveries_crisis.2
	title = magical_discoveries_crisis.2.name
	desc = magical_discoveries_crisis.2.desc
	picture = GFX_evt_ship_in_orbit
	hide_window = no
	## イベントの発生条件
	is_triggered_only = yes
	trigger = {
		has_global_flag = AppearanceAngelFlag
		NOT = {
			has_global_flag = ArrestingAngelFlag
		}
	}
	## イベントの効果
	option = {
		trigger = {
			is_ai = no
		}
		name = magical_discoveries_crisis.2a.name
		set_global_flag = ArrestingAngelFlag
		hidden_effect = {
			country_event = {
				id = magical_discoveries_crisis.3
			}
		}
	}
	option = {
		trigger = {
			is_ai = no
		}
		name = magical_discoveries_crisis.2b.name
		set_global_flag = AttackAngelFlag
		hidden_effect = {
			country_event = {
				id = magical_discoveries_crisis.4
			}
		}
	}
	option = {
		name = magical_discoveries_crisis.2c.name
	}
}

## 	天使の協力
country_event = {
	## イベントの基本情報
	id = magical_discoveries_crisis.3
	title = magical_discoveries_crisis.3.name
	desc = magical_discoveries_crisis.3.desc
	picture = GFX_evt_ship_in_orbit
	hide_window = no
	## イベントの発生条件
	is_triggered_only = yes
	fire_only_once = no
	trigger = {
		is_regular_empire = yes
	}
	## イベントの効果
	option = {
		name = magical_discoveries_crisis.3a.name
		hidden_effect = {
			create_fleet = {
				effect = {
					set_owner = root
					create_fleet = {
						effect = {
							set_owner = prevprev
							create_ship = {
								name = "NAME_Valkyrie"
								design = "NAME_Valkyrie"
								graphical_culture = "extra_dimensional_01"
							}
							assign_leader = last_created_leader
							while = {
								count = 5
								create_ship = {
									name = random
									design = "NAME_soldier_of_the_gods"
									graphical_culture = "extra_dimensional_01"
								}
							}
						}
					}
					assign_leader = last_created_leader
					set_location = {
						target = system_star
						distance = 5
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
				}
			}
		}
	}
}

# 天使を反撃
country_event = {
	id = magical_discoveries_crisis.4
	title = magical_discoveries_crisis.4.name
	desc = magical_discoveries_crisis.4.desc
	picture = GFX_evt_ship_in_orbit
	location = root
	is_triggered_only = yes
	## イベントの効果
	option = {
		name = magical_discoveries_crisis.4a.name
		hidden_effect = {
			solar_system = {
				random_system_planet = {
					limit = {
						is_star = yes
					}
					save_event_target_as = local_star
				}
				create_country = {
					name = "NAME_fallen"
					type = faction
					auto_delete = no
					flag = {
						icon = {
							category = "special"
							file = "extradimensional_02.dds"
						}
						background = {
							category = "backgrounds"
							file = "circle.dds"
						}
						colors = {
							"turquoise"
							"light_blue"
							"null"
							"null"
						}
					}
					effect = {
						establish_communications_no_message = root.owner
						establish_contact = {
							who = root.owner
							location = system_star
						}
						save_global_event_target_as = angel_enemy
						create_fleet = {
							name = "NAME_The_Fallen"
							settings = {
								spawn_debris = yes
							}
							effect = {
								set_owner = event_target:angel_enemy
								create_ship = {
									name = "NAME_Fallen_angel"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_1"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_2"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_3"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_4"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_5"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								create_ship = {
									name = "NAME_Fallen_angel_6"
									design = "NAME_Fallen_angel"
									graphical_culture = "extra_dimensional_01"
								}
								assign_leader = last_created_leader
								while = {
									count = 25
									create_ship = {
										name = random
										design = "NAME_soldier_of_the_gods"
										graphical_culture = "extra_dimensional_01"
									}
								}
								set_location = {
									target = event_target:local_star
									distance = 30
								}
							}
						}
					}
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1000
				# days = 10				#50年後
				days = 18000				#50年後
			}
		}
	}
}

# 天使を撃退
country_event = {
	id = magical_discoveries_crisis.5
	title = magical_discoveries_crisis.5.name
	desc = magical_discoveries_crisis.5.desc
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	location = root
	is_triggered_only = yes
	trigger = {
		exists = event_target:angel_enemy
		from = {
			is_same_value = event_target:angel_enemy
		}
	}
	immediate = {
		event_target:angel_enemy = {
			destroy_country = yes
		}
	}
	option = {
		name = magical_discoveries_crisis.5.a
		trigger = {
			has_country_flag = MeetMagicFlag
		}
		enable_special_project = {
			name = "GOD_SKIN_PROJECT"
			location = capital_scope
			owner = root
		}
	}
	option = {
		name = magical_discoveries_crisis.5.b
	}
}

# 神をどうやって効率的に殺そうか
country_event = {
	id = magical_discoveries_crisis.6
	title = magical_discoveries_crisis.6.name
	desc = magical_discoveries_crisis.6.desc
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	location = root
	is_triggered_only = yes
	option = {
		name = magical_discoveries_crisis.6.a
		add_research_option = tech_gods_skin
		add_tech_progress = {
			tech = tech_gods_skin
			progress = 0.1
		}
		enable_special_project = {
			name = "MYTHICAL_DECAY_PROJECT"
			location = capital_scope
			owner = root
		}
	}
}

# 神をどうやって効率的に殺そうか
country_event = {
	id = magical_discoveries_crisis.7
	title = magical_discoveries_crisis.7.name
	desc = magical_discoveries_crisis.7.desc
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	location = root
	is_triggered_only = yes
	option = {
		name = magical_discoveries_crisis.7.a
		add_research_option = tech_mythical_decay
		add_tech_progress = {
			tech = tech_mythical_decay
			progress = 0.1
		}
	}
}

# 天使を撃退
country_event = {
	id = magical_discoveries_crisis.8
	title = magical_discoveries_crisis.8.name
	desc = magical_discoveries_crisis.8.desc
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	location = root
	is_triggered_only = yes
	trigger = {
		exists = event_target:heavenesgate
		from = {
			is_same_value = event_target:heavenesgate
		}
	}
	option = {
		name = magical_discoveries_crisis.5.8
		trigger = {
			has_country_flag = MeetMagicFlag
		}
		enable_special_project = {
			name = "GOD_SKIN_PROJECT"
			location = capital_scope
			owner = root
		}
	}
	option = {
		name = magical_discoveries_crisis.8.b
	}
}

# 神撃
country_event = {
	id = magical_discoveries_crisis.10001
	hide_window = yes
	trigger = {
		always = no
	}
	immediate = {
		if = {
			limit = {
				NOT = {
					exists = event_target:gate_holder_1
				}
			}
			create_country = {
				name = "NAME_Gate_Holder_1"
				type = gate_holder
				flag = {
					icon = {
						category = "special"
						file = "extradimensional_01.dds"
					}
					background = {
						category = "backgrounds"
						file = "circle.dds"
					}
					colors = {
						"black"
						"blue"
						"null"
						"null"
					}
				}
				effect = {
					save_global_event_target_as = gate_holder_1
					every_playable_country = {
						establish_communications_no_message = event_target:gate_holder_1
					}
				}
			}
		}
		random_country = {
			limit = {
				is_country_type = heavenly_realm
			}
			set_country_flag = heavenly
		}
		random_country = {
			limit = {
				is_country_type = gate_holder
			}
			random_owned_ship = {
				set_ship_flag = heavenly_portal
			}
		}
	}
}

country_event = {
	id = magical_discoveries_crisis.10002
	hide_window = yes
	trigger = {
		always = no
	}
	immediate = {
		random_country = {
			limit = {
				is_country_type = gate_holder
			}
			random_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				set_ship_flag = heavenly_portal
			}
		}
	}
}

# 神罰の始まり (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1000
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	immediate = {
		create_country = {
			name = "NAME_Gate_Holder_1"
			type = gate_holder
			flag = {
				icon = {
					category = "special"
					file = "extradimensional_01.dds"
				}
				background = {
					category = "backgrounds"
					file = "circle.dds"
				}
				colors = {
					"turquoise"
					"light_blue"
					"null"
					"null"
				}
			}
			effect = {
				save_global_event_target_as = gate_holder_1
				every_playable_country = {
					establish_communications_no_message = event_target:gate_holder_1
				}
			}
		}
		set_global_flag = heavenly_invasion_happened
		random_system = {
			limit = {
				NOT = {
					any_country = {
						OR = {
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
						any_system_within_border = {
							is_same_value = prev
						}
					}
				}
			}
			set_star_flag = heavens_origin_system
			save_event_target_as = heavens_system
			random_system_planet = {
				create_species = {
					name = "NAME_Celestialbeing"
					class = EXD
					portrait = heavens1
					traits = random
					effect = {
						save_event_target_as = heavens_species
					}
				}
				create_country = {
					name = "NAME_Celestialbeing"
					type = "heavenly_realm"
					species = event_target:heavens_species
					name_list = "Hevenlyname"
					flag = {
						icon = {
							category = "special"
							file = "extradimensional_01.dds"
						}
						background = {
							category = "backgrounds"
							file = "circle.dds"
						}
						colors = {
							"turquoise"
							"light_blue"
							"null"
							"null"
						}
					}
					effect = {
						set_country_flag = heavenly
						create_ship_design = {
							design = "NAME_Heavenly_Shaper"
						}
						add_ship_design = last_created_design
						create_ship_design = {
							design = "NAME_Heavenly_Anchor"
						}
						add_ship_design = last_created_design
						create_ship_design = {
							design = "NAME_Heavenly_Base"
						}
						add_ship_design = last_created_design
						save_global_event_target_as = heavenesgate
						establish_communications_no_message = event_target:gate_holder_1
						set_faction_hostility = {
							target = event_target:gate_holder_1
							set_hostile = no
						}
						save_event_target_as = heavenesgate
						set_graphical_culture = extra_dimensional_01
					}
				}
				event_target:heavenesgate = {
					create_fleet = {
						name = "NAME_Heavenly_Portal"
						effect = {
							set_owner = PREV
							create_ship = {
								name = random
								design = "NAME_Heavenly_Portal"
								graphical_culture = "extra_dimensional_01"
								effect = {
									set_ship_flag = heavenly_portal
								}
							}
							set_location = {
								target = PREVPREV
								distance = 40
								angle = random
							}
							save_event_target_as = heavenes_gate
							fleet_event = {
								id = magical_discoveries_crisis.1003
								days = 15
							}
							# Second Fleet Arrives
							fleet_event = {
								id = magical_discoveries_crisis.1003
								days = 30
							}
							# Third Fleet Arrives
							fleet_event = {
								id = magical_discoveries_crisis.1003
								days = 55
							}
							# Fourth Fleet Arrives
							fleet_event = {
								id = magical_discoveries_crisis.1003
								days = 365
							}
							# 5 Fleet Arrives
							fleet_event = {
								id = magical_discoveries_crisis.1006
								days = 20
							}
							# First Constructor Arrives
							fleet_event = {
								id = magical_discoveries_crisis.1006
								days = 25
							}
							# Second Constructor Arrives
							event_target:heavenesgate = {
								country_event = {
									id = magical_discoveries_crisis.1260
									days = 350
								}
							}
							# Spawn Cycle starts
							#set_owner = event_target:gate_holder_1 #when first anchor built
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 5
						traits = {
							trait = leader_trait_ethereal
						}
					}
					create_fleet = {
						effect = {
							set_owner = PREV
							create_ship = {
								name = random
								design = "NAME_Gods"
								graphical_culture = "extra_dimensional_01"
							}
							assign_leader = last_created_leader
							while = {
								count = 15
								create_ship = {
									name = random
									design = "NAME_Gods"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 20
								create_ship = {
									name = random
									design = "NAME_Goddess"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 25
								create_ship = {
									name = random
									design = "NAME_soldier_of_the_gods"
									graphical_culture = "extra_dimensional_01"
								}
							}
							set_location = {
								target = event_target:heavenes_gate
								distance = 5
								angle = random
							}
							set_fleet_stance = aggressive
							set_aggro_range = 500
							set_aggro_range_measure_from = self
						}
					}
				}
			}
			if = {
				limit = {
					exists = starbase
				}
				starbase = {
					fleet = {
						destroy_fleet = this
					}
				}
			}
			create_starbase = {
				size = starbase_exd
				owner = event_target:heavenesgate
			}
			star = {
				create_ambient_object = {
					type = "heavens_2"
					location = this
				}
				last_created_ambient_object = {
					set_ambient_object_flag = heavens_system_effect_2
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
		}
		# 扉を無敵にする
		event_target:heavenesgate = {
			random_owned_ship = {
				ship_event = {
					id = magical_discoveries_crisis.1280
				}
			}
		}
		every_country = {
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
				intel_level = {
					level = high
					system = event_target:heavens_system
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1007
			}
		}
		every_country = {
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
				NOT = {
					intel_level = {
						level = high
						system = event_target:heavens_system
					}
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1008
			}
		}
	}
}

# 艦隊の増強 (HIDDEN)
fleet_event = {
	id = magical_discoveries_crisis.1003
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		event_target:heavenesgate = {
			random_list = {
				25 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 6
						traits = {
							trait = leader_trait_ethereal
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_ethereal
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_ethereal
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_ethereal
						}
					}
				}
				25 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 6
						traits = {
							trait = leader_trait_dimensional_stutter
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_dimensional_stutter
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_dimensional_stutter
						}
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_dimensional_stutter
						}
					}
				}
				50 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 5
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
					}
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
					}
				}
			}
			create_fleet = {
				effect = {
					set_owner = PREV
					create_ship = {
						name = random
						design = "NAME_Gods"
						graphical_culture = "extra_dimensional_01"
					}
					assign_leader = last_created_leader
					while = {
						count = 10
						create_ship = {
							name = random
							design = "NAME_Gods"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 15
						create_ship = {
							name = random
							design = "NAME_Goddess"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 20
						create_ship = {
							name = random
							design = "NAME_soldier_of_the_gods"
							graphical_culture = "extra_dimensional_01"
						}
					}
					set_location = {
						target = ROOT
						distance = 5
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
				}
			}
		}
	}
}

# 建設船 (HIDDEN)
fleet_event = {
	id = magical_discoveries_crisis.1006
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		event_target:heavenesgate = {
			create_fleet = {
				effect = {
					set_owner = PREV
					create_ship = {
						name = random
						design = "NAME_Heavenly_Shaper"
						graphical_culture = "extra_dimensional_01"
					}
					set_location = {
						target = ROOT
						distance = 5
						angle = random
					}
				}
			}
		}
	}
}

# お知らせ (High Intel)
country_event = {
	id = magical_discoveries_crisis.1007
	title = "magical_discoveries_crisis.1007.name"
	desc = "magical_discoveries_crisis.1007.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:heavens_system
	is_triggered_only = yes
	after = {
		begin_event_chain = {
			event_chain = "heavenly_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = heavenly_invasion_poi.1
			name = "heavenly_invasion_1_poi"
			desc = "heavenly_invasion_1_poi_desc"
			event_chain = "heavenly_invasion_chain"
			location = event_target:heavens_system
		}
		create_point_of_interest = {
			id = heavenly_invasion_poi.4
			name = "heavenly_invasion_4_poi"
			desc = "heavenly_invasion_4_poi_desc"
			event_chain = "heavenly_invasion_chain"
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "heavenly_invasion_chain"
				counter = "heavenly_anchors_1"
				amount = 1
			}
			country_event = {
				id = magical_discoveries_crisis.1010
			}
		}
	}
	option = {
		name = magical_discoveries_crisis.1007.a
	}
	option = {
		name = magical_discoveries_crisis.1007.b
	}
}

# お知らせ
country_event = {
	id = magical_discoveries_crisis.1008
	title = "magical_discoveries_crisis.1008.name"
	desc = "magical_discoveries_crisis.1008.desc"
	picture = GFX_evt_physics_research
	show_sound = event_alien_signal
	is_triggered_only = yes
	option = {
		name = magical_discoveries_crisis.1008.a
		hidden_effect = {
			country_event = {
				id = magical_discoveries_crisis.1009
				days = 30
			}
		}
	}
}

# 脅威の特定
country_event = {
	id = magical_discoveries_crisis.1009
	title = "magical_discoveries_crisis.1007.name"
	desc = "magical_discoveries_crisis.1009.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	is_triggered_only = yes
	immediate = {
		random_system = {
			limit = {
				has_star_flag = heavens_origin_system
			}
			save_event_target_as = heavens_system
		}
	}
	after = {
		begin_event_chain = {
			event_chain = "heavenly_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = heavenly_invasion_poi.1
			name = "heavenly_invasion_1_poi"
			desc = "heavenly_invasion_1_poi_desc"
			event_chain = "heavenly_invasion_chain"
			location = event_target:heavens_system
		}
		create_point_of_interest = {
			id = heavenly_invasion_poi.4
			name = "heavenly_invasion_4_poi"
			desc = "heavenly_invasion_4_poi_desc"
			event_chain = "heavenly_invasion_chain"
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "heavenly_invasion_chain"
				counter = "heavenly_anchors_1"
				amount = 1
			}
			country_event = {
				id = magical_discoveries_crisis.1010
			}
		}
	}
	option = {
		name = magical_discoveries_crisis.1007.a
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
	}
	option = {
		name = magical_discoveries_crisis.1007.b
		trigger = {
			has_ethic = "ethic_fanatic_authoritarian"
		}
	}
}

# 傍受された送信
country_event = {
	id = magical_discoveries_crisis.1010
	title = "magical_discoveries_crisis.1010.name"
	diplomatic_title = BLANK_STRING
	desc = "magical_discoveries_crisis.1010.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = heavens1
		room = "heavens_room"
	}
	is_triggered_only = yes
	immediate = {
		establish_communications_no_message = event_target:heavenesgate
	}
	option = {
		name = magical_discoveries_crisis.1010.a
	}
}

# 植民地爆撃
planet_event = {
	id = magical_discoveries_crisis.1011
	title = "magical_discoveries_crisis.1011.name"
	desc = "magical_discoveries_crisis.1011.desc"
	picture = GFX_evt_city_ruins
	show_sound = event_ghost_town
	is_triggered_only = yes
	trigger = {
		planet_devastation >= 90
		FROM = {
			is_country_type = heavenly_realm
		}
	}
	immediate = {
		add_threat = {
			who = from
			amount = 2
		}
		destroy_colony = yes
		if = {
			limit = {
				NOR = {
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_habitat
				}
			}
			random_list = {
				50 = {
					change_pc = pc_barren
				}
				50 = {
					change_pc = pc_barren_cold
				}
			}
			reset_planet = yes
			add_modifier = {
				modifier = "terraforming_candidate"
				days = -1
			}
		}
		else_if = {
			limit = {
				is_planet_class = pc_ringworld_habitable
			}
			change_pc = pc_ringworld_habitable_damaged
			reset_planet = yes
		}
		else_if = {
			limit = {
				is_planet_class = pc_habitat
			}
			remove_planet = yes
		}
		every_country = {
			limit = {
				has_event_chain = "heavenly_invasion_chain"
			}
			add_event_chain_counter = {
				event_chain = "heavenly_invasion_chain"
				counter = "heavenly_planets_1"
				amount = 1
			}
		}
		solar_system = {
			if = {
				# 他のコロニーが残っていなければスターベースを建設する
				limit = {
					NOT = {
						exists = starbase
						any_system_planet = {
							has_owner = yes
							owner = {
								NOT = {
									is_same_value = from
								}
							}
						}
					}
				}
				create_starbase = {
					size = starbase_exd_0
					owner = from
				}
				random_ship_in_system = {
					limit = {
						owner = {
							is_same_value = from
						}
					}
					ship_event = {
						id = magical_discoveries_crisis.1300
					}					# Check if starbase should be Anchor
					ship_event = {
						id = magical_discoveries_crisis.1310
					}					# Create system effect
				}
			}
		}
	}
	option = {
		name = magical_discoveries_crisis.1011.a
	}
}

# ポータルの破壊 (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1012
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
		FROMFROM = {
			is_ship_size = dimensional_portal_ed
		}
	}
	immediate = {
		random_system = {
			limit = {
				has_star_flag = heavens_origin_system
			}
			random_system_ambient_object = {
				limit = {
					has_ambient_object_flag = heavens_system_effect_2
				}
				destroy_ambient_object = this
			}
		}
		if = {
			limit = {
				OR = {
					NOT = {
						has_global_flag = extradimensional_second_portal
					}
					AND = {
						has_global_flag = extradimensional_second_portal_destroyed
						has_global_flag = extradimensional_third_portal_destroyed
					}
				}
			}
			FROM = {
				save_event_target_as = gate_killer
				if = {
					limit = {
						is_ai = no
					}
					country_event = {
						id = magical_discoveries_crisis.1250
						days = 10
						random = 10
					}
				}
			}
			every_playable_country = {
				if = {
					limit = {
						has_communications = FROM
					}
					add_opinion_modifier = {
						who = FROM
						modifier = opinion_destroyed_portal
					}
				}
				add_modifier = {
					modifier = "heavenesgate_defeated"
					days = 360
				}
				country_event = {
					id = magical_discoveries_crisis.1013
				}
			}
		}
	}
}

# ポータルの破壊
country_event = {
	id = magical_discoveries_crisis.1013
	title = "magical_discoveries_crisis.1013.name"
	desc = "magical_discoveries_crisis.1013.desc"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion
	is_triggered_only = yes
	immediate = {
		random_system = {
			limit = {
				has_star_flag = heavens_origin_system
			}
			save_event_target_as = heavens_system
		}
		remove_point_of_interest = heavenly_invasion_poi.1
		set_country_flag = heavenesgate_expunged
		set_global_flag = heavenly_portal_destroyed
	}
	option = {
		name = magical_discoveries_crisis.1013.a
	}
}

# 天界人との外交
country_event = {
	id = magical_discoveries_crisis.1050
	title = "TRANSMISSION"
	desc = {
		text = magical_discoveries_crisis.1050.desc
	}
	diplomatic = yes
	force_open = yes
	picture_event_data = {
		portrait = heavens1
		room = "heavens_room"
	}
	is_triggered_only = yes
	trigger = {
		FROM = {
			is_country_type = heavenly_realm
		}
	}
	option = {
		name = magical_discoveries_crisis.1050.a
		trigger = {
			OR = {
				has_ethic = "ethic_pacifist"
				has_ethic = "ethic_fanatic_pacifist"
			}
		}
		response_text = magical_discoveries_crisis.1050.a.response
	}
	option = {
		name = magical_discoveries_crisis.1050.b
		trigger = {
			OR = {
				has_ethic = "ethic_militarist"
				has_ethic = "ethic_fanatic_militarist"
				has_authority = auth_machine_intelligence
			}
		}
		response_text = magical_discoveries_crisis.1050.b.response
	}
	option = {
		name = magical_discoveries_crisis.1050.c
		trigger = {
			OR = {
				has_ethic = "ethic_xenophobe"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		response_text = magical_discoveries_crisis.1050.c.response
	}
	option = {
		name = magical_discoveries_crisis.1050.d
		trigger = {
			OR = {
				has_ethic = "ethic_xenophile"
				has_ethic = "ethic_fanatic_xenophile"
			}
			NOT = {
				owner_species = {
					has_trait = trait_mechanical
				}
			}
		}
		response_text = magical_discoveries_crisis.1050.d.response
	}
	option = {
		name = magical_discoveries_crisis.1050.e
		trigger = {
			OR = {
				has_ethic = "ethic_spiritualist"
				has_ethic = "ethic_fanatic_spiritualist"
			}
			NOT = {
				owner_species = {
					has_trait = trait_psionic
				}
			}
		}
		response_text = magical_discoveries_crisis.1050.e.response
	}
	option = {
		name = magical_discoveries_crisis.1050.f
		trigger = {
			owner_species = {
				has_trait = trait_psionic
			}
		}
		response_text = magical_discoveries_crisis.1050.f.response
	}
}

# 天界との戦い
#ポータルがなく、5隻以下の船しか残っていない場合、EXDを破壊する
#年に一度で
event = {
	id = magical_discoveries_crisis.1254
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		any_country = {
			is_country_type = heavenly_realm
		}
	}
	immediate = {
		if = {
			limit = {
				any_country = {
					is_country_type = heavenly_realm
					has_global_flag = heavenly_portal_destroyed
					num_ships < 6
					NOR = {
						any_owned_ship = {
							is_ship_size = dimensional_portal_ed
						}
						any_country = {
							is_country_type = gate_holder
							any_owned_ship = {
								is_ship_size = dimensional_portal_ed
							}
						}
					}
					NOT = {
						any_system = {
							any_system_planet = {
								controller = {
									is_country_type = heavenly_realm
								}
							}
						}
					}
					NOT = {
						any_system = {
							any_system_planet = {
								owner = {
									is_country_type = heavenly_realm
								}
							}
						}
					}
				}
			}
			every_country = {
				limit = {
					is_country_type = heavenly_realm
				}
				destroy_country = yes
			}
		}
	}
}

# 増援隊のスポーンサイクル (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1260
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
		OR = {
			count_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				count > 0
			}
			any_country = {
				is_country_type = gate_holder
				count_owned_ship = {
					limit = {
						is_ship_size = dimensional_portal_ed
					}
					count > 0
				}
			}
		}
	}
	immediate = {
		# Spawn Construction Ships if needed
		country_event = {
			id = magical_discoveries_crisis.1266
			days = 6
		}
		# If at fleet cap
		if = {
			limit = {
				num_ships > 2000
			}
			country_event = {
				id = magical_discoveries_crisis.1260
				days = 600
				random = 200
			}
			# Check again later
		}
		# If no Anchors
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count < 1
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 1500
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 1
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 1300
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 2
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 1100
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 3
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 900
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 4
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 600
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 5
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 400
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 6
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 400
				random = 200
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 7
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 300
				random = 100
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 8
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 250
				random = 50
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count = 9
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 200
				random = 50
			}
		}
		else_if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count > 9
				}
			}
			country_event = {
				id = magical_discoveries_crisis.1265
				days = 150
				random = 50
			}
		}
	}
}

# 援軍到着 (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1265
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		# Must only trigger if portal is still alive
		OR = {
			count_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				count > 0
			}
			any_country = {
				AND = {
					is_country_type = gate_holder
					count_owned_ship = {
						limit = {
							is_ship_size = dimensional_portal_ed
						}
						count > 0
					}
				}
			}
		}
	}
	immediate = {
		random_country = {
			limit = {
				is_country_type = gate_holder
			}
			random_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				save_event_target_as = heavenes_gate
			}
		}
		random_owned_ship = {
			limit = {
				is_ship_size = dimensional_portal_ed
			}
			save_event_target_as = heavenes_gate
		}
		owner_species = {
			save_event_target_as = heavens_species
		}
		country_event = {
			id = magical_discoveries_crisis.1260
		}
		# Restart spawn cycle
		# Extradimensionals 1
		if = {
			limit = {
				is_country_type = heavenly_realm
			}
			# Create Admiral
			random_list = {
				25 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_ethereal
						}
					}
				}
				25 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
						traits = {
							trait = leader_trait_dimensional_stutter
						}
					}
				}
				50 = {
					create_leader = {
						class = admiral
						species = event_target:heavens_species
						name = random
						skill = 3
					}
				}
			}
			# Create Fleet
			create_fleet = {
				effect = {
					set_owner = ROOT
					create_ship = {
						name = random
						design = "NAME_Gods"
						graphical_culture = "extra_dimensional_01"
					}
					assign_leader = last_created_leader
					while = {
						count = 4
						create_ship = {
							name = random
							design = "NAME_Gods"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 10
						create_ship = {
							name = random
							design = "NAME_Goddess"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 15
						create_ship = {
							name = random
							design = "NAME_soldier_of_the_gods"
							graphical_culture = "extra_dimensional_01"
						}
					}
					set_location = {
						target = event_target:heavenes_gate
						distance = 5
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
				}
			}
		}
	}
}

# 必要に応じて建設船が到着 (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1266
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		# Must only trigger if portal is still alive
		OR = {
			count_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				count > 0
			}
			any_country = {
				AND = {
					is_country_type = gate_holder
					count_owned_ship = {
						limit = {
							is_ship_size = dimensional_portal_ed
						}
						count > 0
					}
				}
			}
		}
		count_owned_ship = {
			limit = {
				is_ship_size = construction_ship_ed
			}
			count < 3
		}
	}
	immediate = {
		# Extradimensionals 1
		random_country = {
			limit = {
				is_country_type = gate_holder
			}
			random_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				save_event_target_as = heavenes_gate
			}
		}
		random_owned_ship = {
			limit = {
				is_ship_size = dimensional_portal_ed
			}
			save_event_target_as = heavenes_gate
		}
		if = {
			limit = {
				is_country_type = heavenly_realm
			}
			while = {
				count = 2
				create_fleet = {
					effect = {
						set_owner = ROOT
						create_ship = {
							name = random
							design = "NAME_Heavenly_Shaper"
							graphical_culture = "extra_dimensional_01"
						}
						set_location = {
							target = event_target:heavenes_gate
							distance = 5
							angle = random
						}
					}
				}
			}
		}
	}
}

# アンカーを構築した後、増援部隊が到着 (HIDDEN)
ship_event = {
	id = magical_discoveries_crisis.1267
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		owner = {
			is_country_type = heavenly_realm
			# ポータルがまだ生きている場合にのみ起動する必要があります。
			OR = {
				count_owned_ship = {
					limit = {
						is_ship_size = dimensional_portal_ed
					}
					count > 0
				}
				any_country = {
					AND = {
						is_country_type = gate_holder
						count_owned_ship = {
							limit = {
								is_ship_size = dimensional_portal_ed
							}
							count > 0
						}
					}
				}
			}
			is_country_type = heavenly_realm
			num_ships < 2001
		}
	}
	immediate = {
		owner = {
			country_event = {
				id = magical_discoveries_crisis.1266
				days = 6
			}
			# 必要に応じて建設船をスポーン
			random_country = {
				limit = {
					is_country_type = gate_holder
				}
				random_owned_ship = {
					limit = {
						is_ship_size = dimensional_portal_ed
					}
					save_event_target_as = heavenes_gate
				}
			}
			random_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				save_event_target_as = heavenes_gate
			}
			owner_species = {
				save_event_target_as = heavens_species
			}
			if = {
				limit = {
					is_country_type = heavenly_realm
				}
				# Create Admiral
				random_list = {
					25 = {
						create_leader = {
							class = admiral
							species = event_target:heavens_species
							name = random
							skill = 3
							traits = {
								trait = leader_trait_ethereal
							}
						}
					}
					25 = {
						create_leader = {
							class = admiral
							species = event_target:heavens_species
							name = random
							skill = 3
							traits = {
								trait = leader_trait_dimensional_stutter
							}
						}
					}
					50 = {
						create_leader = {
							class = admiral
							species = event_target:heavens_species
							name = random
							skill = 3
						}
					}
				}
				# Create Fleet
				create_fleet = {
					effect = {
						set_owner = ROOT.owner
						create_ship = {
							name = random
							design = "NAME_Gods"
							graphical_culture = "extra_dimensional_01"
						}
						assign_leader = last_created_leader
						while = {
							count = 4
							create_ship = {
								name = random
								design = "NAME_Gods"
								graphical_culture = "extra_dimensional_01"
							}
						}
						while = {
							count = 10
							create_ship = {
								name = random
								design = "NAME_Goddess"
								graphical_culture = "extra_dimensional_01"
							}
						}
						while = {
							count = 15
							create_ship = {
								name = random
								design = "NAME_soldier_of_the_gods"
								graphical_culture = "extra_dimensional_01"
							}
						}
						set_location = {
							target = event_target:heavenes_gate
							distance = 5
							angle = random
						}
						set_fleet_stance = aggressive
						set_aggro_range = 500
						set_aggro_range_measure_from = self
					}
				}
			}
		}
	}
}

# 神罰の終わり (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1270
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
		NOT = {
			any_country = {
				AND = {
					NOT = {
						is_same_value = ROOT
					}
					is_country_type = heavenly_realm
				}
			}
		}
	}
	immediate = {
		# 危機の報酬は、コミュニティが存在する場合は、銀河フォーカスを介して処理されます。
		if = {
			limit = {
				NOT = {
					has_global_flag = galactic_community_formed
				}
			}
			every_country = {
				limit = {
					OR = {
						is_country_type = default
						is_country_type = fallen_empire
					}
				}
				country_event = {
					id = magical_discoveries_crisis.1271
				}
			}
		}
		set_global_flag = heavenly_invasion_defeated
	}
}

# 神罰の終わり
country_event = {
	id = magical_discoveries_crisis.1271
	title = "magical_discoveries_crisis.1271.name"
	desc = "magical_discoveries_crisis.1271.desc"
	picture = GFX_evt_metropolis
	show_sound = event_celebration
	is_triggered_only = yes
	immediate = {
		end_event_chain = "heavenly_invasion_chain"
	}
	option = {
		# Spiritualist Response
		name = magical_discoveries_crisis.1271.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Militarist Response
		name = magical_discoveries_crisis.1271.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Materialist Response
		name = magical_discoveries_crisis.1271.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Pacifist Response
		name = magical_discoveries_crisis.1271.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Corporate Response
		name = magical_discoveries_crisis.1271.e
		trigger = {
			has_government = gov_megacorporation
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Default Response
		name = magical_discoveries_crisis.1271.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_authority = auth_machine_intelligence
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Xenophobe Response
		name = magical_discoveries_crisis.1271.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Xenophile Response
		name = magical_discoveries_crisis.1271.h
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
}

# Anchor Built (HIDDEN)
ship_event = {
	id = magical_discoveries_crisis.1280
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		owner = {
			is_country_type = heavenly_realm
		}
		#is_ship_size = starbase_exd # now implicit
	}
	immediate = {
		owner = {
			log = "anchor built and magical_discoveries_crisis.1280 executed, not yet reaching fleet owner switch"
			random_country = {
				limit = {
					is_country_type = gate_holder
				}
				save_event_target_as = gate_holder_1
			}
			random_owned_ship = {
				limit = {
					is_ship_size = dimensional_portal_ed
				}
				fleet = {
					set_event_locked = yes
					set_owner = event_target:gate_holder_1
					log = "anchor built and magical_discoveries_crisis.1280 executed, reaching fleet owner switch"
				}
			}
		}
		if = {
			limit = {
				owner = {
					is_country_type = heavenly_realm
				}
			}
			every_country = {
				limit = {
					has_event_chain = "heavenly_invasion_chain"
				}
				add_event_chain_counter = {
					event_chain = "heavenly_invasion_chain"
					counter = "heavenly_anchors_1"
					amount = 1
				}
			}
		}
	}
}

# Anchor Destroyed (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1281
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		FROMFROM = {
			is_ship_size = starbase_exd
		}
	}
	immediate = {
		log = "anchor destroyed event magical_discoveries_crisis.1281 triggered"
		if = {
			limit = {
				count_owned_ship = {
					limit = {
						is_ship_size = starbase_exd
					}
					count < 1
				}
			}
			switch = {
				trigger = has_country_flag
				heavenly = {
					random_country = {
						limit = {
							is_country_type = gate_holder
						}
						random_owned_ship = {
							limit = {
								is_ship_size = dimensional_portal_ed
								has_ship_flag = heavenly_portal
							}
							fleet = {
								set_owner = root
							}
							fleet = {
								set_event_locked = no
							}
						}
					}
				}
				aberrant = {
					random_country = {
						limit = {
							is_country_type = gate_holder
						}
						random_owned_ship = {
							limit = {
								is_ship_size = dimensional_portal_ed
								has_ship_flag = aberrant_portal
							}
							fleet = {
								set_owner = root
							}
							fleet = {
								set_event_locked = no
							}
						}
					}
				}
				vehement = {
					random_country = {
						limit = {
							is_country_type = gate_holder
						}
						random_owned_ship = {
							limit = {
								is_ship_size = dimensional_portal_ed
								has_ship_flag = vehement_portal
							}
							fleet = {
								set_owner = root
							}
							fleet = {
								set_event_locked = no
							}
						}
					}
				}
			}
		}
		if = {
			limit = {
				is_country_type = heavenly_realm
			}
			every_country = {
				limit = {
					has_event_chain = "heavenly_invasion_chain"
				}
				add_event_chain_counter = {
					event_chain = "heavenly_invasion_chain"
					counter = "heavenly_anchors_1"
					amount = -1
				}
			}
		}
	}
}

# Extradimensional Kill Count (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1282
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
	}
	immediate = {
		if = {
			limit = {
				is_country_type = heavenly_realm
				FROM = {
					has_event_chain = "heavenly_invasion_chain"
				}
			}
			FROM = {
				add_event_chain_counter = {
					event_chain = "heavenly_invasion_chain"
					counter = "heavenly_kills_us_1"
					amount = 1
				}
			}
		}
		if = {
			limit = {
				is_country_type = heavenly_realm
			}
			every_country = {
				limit = {
					has_event_chain = "heavenly_invasion_chain"
					NOT = {
						is_same_value = FROM
					}
				}
				add_event_chain_counter = {
					event_chain = "heavenly_invasion_chain"
					counter = "heavenly_kills_others_1"
					amount = 1
				}
			}
		}
	}
}

# Extradimensional Victims (HIDDEN)
country_event = {
	id = magical_discoveries_crisis.1283
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
		FROM = {
			NOR = {
				is_country_type = heavenly_realm
			}
		}
	}
	immediate = {
		if = {
			limit = {
				is_country_type = heavenly_realm
			}
			every_country = {
				limit = {
					has_event_chain = "heavenly_invasion_chain"
				}
				add_event_chain_counter = {
					event_chain = "heavenly_invasion_chain"
					counter = "heavenly_victims_1"
					amount = 1
				}
			}
		}
	}
}

# 神を捕まえる
country_event = {
	id = magical_discoveries_crisis.1250
	title = "magical_discoveries_crisis.1250.name"
	desc = "magical_discoveries_crisis.1250.desc"
	picture = GFX_evt_surreal_visions
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	option = {
		name = magical_discoveries_crisis.1250a.name
		# add_relic = r_the_sealed_god
	}
}

# Build Anchors
ship_event = {
	id = magical_discoveries_crisis.1300
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		owner = {
			count_starbase_sizes = {
				starbase_size = starbase_exd_0
				count <= 99
			}
		}
	}
	immediate = {
		if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 90
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
			# スターベースがまだ存在しないため、このように行われました。
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 80
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 9
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 70
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 8
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 60
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 7
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 50
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 6
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 40
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 5
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 30
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 4
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 20
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 3
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
		else_if = {
			limit = {
				owner = {
					count_starbase_sizes = {
						starbase_size = starbase_exd_0
						count >= 10
					}
					count_starbase_sizes = {
						starbase_size = starbase_exd
						count < 2
					}
				}
			}
			ship_event = {
				id = magical_discoveries_crisis.1301
				days = 1
			}
		}
	}
}

# Build Anchors
ship_event = {
	id = magical_discoveries_crisis.1301
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		solar_system = {
			starbase = {
				set_starbase_size = starbase_exd
			}
		}
		ship_event = {
			id = magical_discoveries_crisis.1267
		}
		# アンカーを構築した後、増援部隊が到着
		ship_event = {
			id = magical_discoveries_crisis.1280
		}
		# Anchor Built
	}
}

# スポーンシステム効果
ship_event = {
	id = magical_discoveries_crisis.1310
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		solar_system = {
			star = {
				create_ambient_object = {
					type = "heavens_1"
					location = this
				}
				last_created_ambient_object = {
					set_ambient_object_flag = heavens_system_effect
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
		}
	}
}

# システムエフェクトの削除
country_event = {
	id = magical_discoveries_crisis.1311
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = heavenly_realm
		fromfrom = {
			OR = {
				is_ship_size = starbase_exd_0
				is_ship_size = starbase_exd
			}
		}
	}
	immediate = {
		fromfrom = {
			solar_system = {
				random_system_ambient_object = {
					limit = {
						has_ambient_object_flag = heavens_system_effect
					}
					destroy_ambient_object = this
				}
			}
		}
	}
}

# 宇宙基地を破壊した次元外生物
starbase_event = {
	id = magical_discoveries_crisis.1320
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from.owner = {
			is_country_type = heavenly_realm
		}
		NOT = {
			solar_system = {
				any_system_planet = {
					is_colony = yes
				}				# 人口の多いシステムでは、コロニーを破壊する必要があります。
			}
		}
	}
	immediate = {
		solar_system = {
			save_event_target_as = heavenes_starbase_system
		}
		from.owner = {
			country_event = {
				id = magical_discoveries_crisis.1321
				days = 5
			}			# 破壊されたスターベースを適切に撤去するための遅延
		}
	}
}

# 宇宙人が新しいスターベースを作る
country_event = {
	id = magical_discoveries_crisis.1321
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		event_target:heavenes_starbase_system = {
			solar_system = {
				create_starbase = {
					size = starbase_exd_0
					owner = root
				}
				every_system_planet = {
					limit = {
						has_orbital_station = yes
					}
					orbital_station = {
						dismantle = yes
					}
				}
			}
		}
		if = {
			limit = {
				exists = fromfrom
			}
			fromfrom = {
				if = {
					limit = {
						#理論的には、ジャンプした可能性もあります。
						exists = solar_system
					}
					random_owned_ship = {
						ship_event = {
							id = magical_discoveries_crisis.1300
						}						# スターベースをアンカーにするかどうかのチェック
						ship_event = {
							id = magical_discoveries_crisis.1310
						}						# システム効果の創出
					}
				}
			}
		}
	}
}
